<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Classifying Texts with tidyllm • tidyllm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Classifying Texts with tidyllm">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidyllm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/tidyllm.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/tidyllm_classifiers.html">Classifying Texts with tidyllm</a></li>
    <li><a class="dropdown-item" href="../articles/tidyllm-pdfquestions.html">Structured Question Answering from PDFs</a></li>
    <li><a class="dropdown-item" href="../articles/tidyllm-synthetic-data.html">Generate Synthetic Data with tidyllm</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/edubruell/tidyllm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Classifying Texts with tidyllm</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/edubruell/tidyllm/blob/HEAD/vignettes/articles/tidyllm_classifiers.Rmd" class="external-link"><code>vignettes/articles/tidyllm_classifiers.Rmd</code></a></small>
      <div class="d-none name"><code>tidyllm_classifiers.Rmd</code></div>
    </div>

    
    
<p>Classification tasks are a key challenge when dealing with
unstructured data in surveys, customer feedback, or for image analysis.
This article introduces a practical, step-by-step guide to using
<strong>tidyllm</strong> for classifying text, streamlining the
process.</p>
<div class="section level2">
<h2 id="a-common-classification-task">A Common Classification Task<a class="anchor" aria-label="anchor" href="#a-common-classification-task"></a>
</h2>
<p>Imagine you’ve just collected thousands of survey responses where
people describe their jobs in their own words. Some responses are
detailed, others are vague, and there’s plenty of variation in between.
Now, you need to categorize these into standardized occupation codes,
like those from the SOC classification system of the Bureau of Labor
Statistics. Manually sorting through each response could take days, if
not weeks, and inconsistencies between coders are almost guaranteed. For
instance, your dataset might look something like this: 7,000 rows of
occupation descriptions, ranging from “Librarian” to “Making sure
everything runs”</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edubruell/tidyllm" class="external-link">tidyllm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/" class="external-link">glue</a></span><span class="op">)</span></span>
<span><span class="va">occ_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">read_rds</a></span><span class="op">(</span><span class="st">"occupation_data.rds"</span><span class="op">)</span></span>
<span><span class="va">occ_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7,000 × 2</span></span></span>
<span><span class="co">#&gt;    respondent occupation_open                  </span></span>
<span><span class="co">#&gt;         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     <span style="text-decoration: underline;">100</span>019 Ops oversight and strategy       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     <span style="text-decoration: underline;">100</span>266 Coordinating operations          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     <span style="text-decoration: underline;">100</span>453 Making sure everything runs      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     <span style="text-decoration: underline;">100</span>532 Building and demolition          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     <span style="text-decoration: underline;">100</span>736 Help lawyers with cases          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     <span style="text-decoration: underline;">100</span>910 I sell mechanical parts          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     <span style="text-decoration: underline;">101</span>202 Librarian                        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     <span style="text-decoration: underline;">101</span>325 Operations planning and execution</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     <span style="text-decoration: underline;">101</span>329 Bookkeeper                       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     <span style="text-decoration: underline;">101</span>367 Kitchen staff                    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6,990 more rows</span></span></span></code></pre></div>
<p>Our goal is to classify these messy responses into one of these 22
2-digit occupation codes:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occ_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">read_rds</a></span><span class="op">(</span><span class="st">"occ_codes_2digits.rds"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span>n<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 22 × 2</span></span></span>
<span><span class="co">#&gt;     occ2 occ_title                                                 </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                                     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    11 Management Occupations                                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    13 Business and Financial Operations Occupations             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    15 Computer and Mathematical Occupations                     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    17 Architecture and Engineering Occupations                  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    19 Life, Physical, and Social Science Occupations            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    21 Community and Social Service Occupations                  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    23 Legal Occupations                                         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    25 Educational Instruction and Library Occupations           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    27 Arts, Design, Entertainment, Sports, and Media Occupations</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    29 Healthcare Practitioners and Technical Occupations        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>    31 Healthcare Support Occupations                            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>    33 Protective Service Occupations                            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>    35 Food Preparation and Serving Related Occupations          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>    37 Building and Grounds Cleaning and Maintenance Occupations </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>    39 Personal Care and Service Occupations                     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span>    41 Sales and Related Occupations                             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span>    43 Office and Administrative Support Occupations             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span>    45 Farming, Fishing, and Forestry Occupations                </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span>    47 Construction and Extraction Occupations                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span>    49 Installation, Maintenance, and Repair Occupations         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">21</span>    51 Production Occupations                                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">22</span>    53 Transportation and Material Moving Occupations</span></span></code></pre></div>
<p>In this article, we take a structured approach to tackle the
classification task efficiently. Here’s a step-by-step workflow for this
kind of task:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Classifying and Manually Correcting a Sub-Sample</strong>:
<ul>
<li>
<strong>Pick a Sample</strong>:Start by filtering the dataset to
retain only distinct occupation descriptions. Then, randomly select a
sample of distinct responses to work with. For this example, let’s
select 20% of the dataset for manual classification and correction.</li>
<li>
<strong>Initial Classification</strong>: Use a simple prompt to
categorize these responses into occupation codes.</li>
<li>
<strong>Manual Correction</strong>: Review and correct the
classifications to create a reliable ground truth.</li>
</ul>
</li>
<li>
<strong>Optimizing the Classification Process</strong>:
<ul>
<li>
<strong>Training/Test Split</strong>: Again split this ground truth
dataset using <code>rsample</code> into training and test sets.</li>
<li>
<strong>Experimentation</strong>: Test different prompts, models,
and parameters on the training set, comparing one-shot and multi-shot
approaches.</li>
<li>
<strong>Model Evaluation</strong>: Use <code>yardstick</code> to
find the best-performing combination on the training data.</li>
<li>
<strong>Testing</strong>: Apply the best-performing model to the
test set to evaluate how well it performs on unseen occupation
descriptions.</li>
</ul>
</li>
<li>
<strong>Scaling Up to the Full Dataset</strong>:
<ul>
<li>
<strong>Full Classification</strong>: Use the validated model setup
to classify the entire dataset efficiently.</li>
</ul>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="classifying-a-sub-sample">Classifying a Sub-Sample<a class="anchor" aria-label="anchor" href="#classifying-a-sub-sample"></a>
</h2>
<p>We start by ensuring we only classify distinct responses. This
eliminates duplicates and ensures a more efficient and reliable
classification process:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pick only distinct occupations from the dataset</span></span>
<span><span class="va">distinct_occupations</span> <span class="op">&lt;-</span> <span class="va">occ_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span>occupation <span class="op">=</span> <span class="va">occupation_open</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">distinct_occupations</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2,209 × 1</span></span></span>
<span><span class="co">#&gt;   occupation                 </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Ops oversight and strategy </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Coordinating operations    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Making sure everything runs</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Building and demolition    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Help lawyers with cases    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2,204 more rows</span></span></span></code></pre></div>
<p>This will help us focus on variations across distinct occupations,
avoiding repeated classification efforts on identical responses.</p>
<p>Next, we divide the distinct occupations into a sub-sample for manual
classification and a remaining portion to be used later. We use the
<code><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">initial_split()</a></code> function from the <code>rsample</code>
package, splitting 10% of the data into a smaller test set for manual
correction and model training:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Set a seed for reproducability</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split the distinct occupations into a sub-sample (10%) and the rest (90%)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org" class="external-link">rsample</a></span><span class="op">)</span></span>
<span><span class="va">occ_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">initial_split</a></span><span class="op">(</span><span class="va">distinct_occupations</span>, prop <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Retrieve the sub-sample and the remaining data</span></span>
<span><span class="va">rest_of_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">training</a></span><span class="op">(</span><span class="va">occ_split</span><span class="op">)</span></span>
<span><span class="va">sub_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">testing</a></span><span class="op">(</span><span class="va">occ_split</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sub_sample</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> </span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 442 × 1</span></span></span>
<span><span class="co">#&gt;   occupation                     </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Making sure everything runs    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Bartender                      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Post-secondary health education</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Food servin                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Exectutive assistant           </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 437 more rows</span></span></span></code></pre></div>
<p>By splitting the data, we now have a smaller sub-sample of 422
observations to work with during the initial classification stage.</p>
<div class="section level3">
<h3 id="writing-an-initial-classifier-function">Writing an initial classifier function<a class="anchor" aria-label="anchor" href="#writing-an-initial-classifier-function"></a>
</h3>
<p>To classify this sub-sample of occupation descriptions, we use a
first function that wraps <code><a href="../reference/llm_message.html">llm_message()</a></code>. This function
sends each occupation description to a large language model (LLM) and
prompts it to assign one of the pre-defined occupation codes. For this
first step, we choose a reliable commercial model to make our lives
easier, as it requires fewer manual corrections due to its high-quality
output, helping us build a more accurate ground truth:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">classify_occupation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">occupation</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Output what the model is currently doing to the console</span></span>
<span>  <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"Classifying: {occupation}\n"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Generate the prompt</span></span>
<span>  <span class="va">prompt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">      Classify this occupation response from a survey: {occupation}</span></span>
<span><span class="st">      </span></span>
<span><span class="st">      Pick one of the following numerical codes from this list. </span></span>
<span><span class="st">      Respond only with the code!</span></span>
<span><span class="st">      11 = Management Occupations                                    </span></span>
<span><span class="st">      13 = Business and Financial Operations Occupations             </span></span>
<span><span class="st">      15 = Computer and Mathematical Occupations                     </span></span>
<span><span class="st">      17 = Architecture and Engineering Occupations                  </span></span>
<span><span class="st">      19 = Life, Physical, and Social Science Occupations            </span></span>
<span><span class="st">      21 = Community and Social Service Occupations                  </span></span>
<span><span class="st">      23 = Legal Occupations                                         </span></span>
<span><span class="st">      25 = Educational Instruction and Library Occupations           </span></span>
<span><span class="st">      27 = Arts, Design, Entertainment, Sports, and Media Occupations</span></span>
<span><span class="st">      29 = Healthcare Practitioners and Technical Occupations        </span></span>
<span><span class="st">      31 = Healthcare Support Occupations                            </span></span>
<span><span class="st">      33 = Protective Service Occupations                            </span></span>
<span><span class="st">      35 = Food Preparation and Serving Related Occupations          </span></span>
<span><span class="st">      37 = Building and Grounds Cleaning and Maintenance Occupations </span></span>
<span><span class="st">      39 = Personal Care and Service Occupations                     </span></span>
<span><span class="st">      41 = Sales and Related Occupations                             </span></span>
<span><span class="st">      43 = Office and Administrative Support Occupations             </span></span>
<span><span class="st">      45 = Farming, Fishing, and Forestry Occupations                </span></span>
<span><span class="st">      47 = Construction and Extraction Occupations                   </span></span>
<span><span class="st">      49 = Installation, Maintenance, and Repair Occupations         </span></span>
<span><span class="st">      51 = Production Occupations                                    </span></span>
<span><span class="st">      53 = Transportation and Material Moving Occupations</span></span>
<span><span class="st">      99 = Missing Occupation (No clear occupation)'</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># List of valid codes as strings</span></span>
<span>  <span class="va">valid_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">occ_codes</span><span class="op">$</span><span class="va">occ2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Initialize classification_raw</span></span>
<span>  <span class="va">classification</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># Get the assistant's reply</span></span>
<span>    <span class="va">assistant_reply</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_message.html">llm_message</a></span><span class="op">(</span><span class="va">prompt</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/claude.html">claude</a></span><span class="op">(</span>.model <span class="op">=</span> <span class="st">"claude-3-5-sonnet-20240620"</span>, .temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/last_reply.html">last_reply</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_squish</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Validate the assistant's reply</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">assistant_reply</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">valid_codes</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">assistant_reply</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># If the reply is not a valid code, set code 98</span></span>
<span>      <span class="fl">98L</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># If there's an error with the model, set code 97</span></span>
<span>    <span class="fl">97L</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Output a tibble</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    occupation_open <span class="op">=</span> <span class="va">occupation</span>,</span>
<span>    occ2            <span class="op">=</span> <span class="va">classification</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Here’s How It Works:</strong></p>
<ol style="list-style-type: decimal">
<li><p><strong>Prompt Generation</strong>: The function creates a
detailed prompt that instructs the model to classify the occupation into
one of the 22 SOC codes. This structured prompt ensures the model
provides clear and accurate outputs. We use <code><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue()</a></code> to add
the function input (i.e. a response in the open occupation question)
into the prompt with <code>{occupation}</code>.</p></li>
<li><p><strong>Calling the LLM</strong>: The model (in this case,
Claude-3.5-Sonnet) is called using the <code><a href="../reference/claude.html">claude()</a></code> function
with the <code>.temperature</code> parameter set to 0, ensuring
deterministic (non-random) output. The model’s reply is retrieved and
cleaned using <code><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_squish()</a></code> to remove unnecessary
spaces:</p></li>
</ol>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/llm_message.html">llm_message</a></span><span class="op">(</span><span class="va">prompt</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/claude.html">claude</a></span><span class="op">(</span>.model <span class="op">=</span> <span class="st">"claude-3-5-sonnet-20240620"</span>, .temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/last_reply.html">last_reply</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_squish</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li><p><strong>Error Handling</strong>: The function uses
<code>tryCatch</code> to handle any errors during the classification
process. If the API call fails, the function returns occupation code
<code>97</code> to flag the issue.</p></li>
<li><p><strong>Validation of Model Output</strong>: The function checks
whether the model’s response is a valid SOC code. If the response is
invalid, it assigns code <code>98</code>. This validation ensures that
any unexpected outputs are handled appropriately.</p></li>
<li><p><strong>Returning the Result</strong>: The function outputs a
<code>tibble</code> containing the original occupation description and
the model’s classification or error code, providing a clean and
structured result.</p></li>
</ol>
<p>A typical function outputs look like this:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">classify_occupation</span><span class="op">(</span><span class="st">"Software Engineer"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   occupation_open    occ2</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Software Engineer    15</span></span></code></pre>
<p>Next, we apply our classifier to the entire sub-sample in one go
using <code><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr()</a></code> from the purrr package, efficiently
generating a tibble that contains the classification results for each
occupation description.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sub_sample_classified</span> <span class="op">&lt;-</span> <span class="va">sub_sample</span><span class="op">$</span><span class="va">occupation</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">classify_occupation</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Classifying: Making sure everything runs</span></span>
<span><span class="co">#&gt; Classifying: Bartender</span></span>
<span><span class="co">#&gt; Classifying: Post-secondary health education</span></span>
<span><span class="co">#&gt; Classifying: Food servin</span></span>
<span><span class="co">#&gt; Classifying: Exectutive assistant</span></span>
<span><span class="co">#&gt; Classifying: ...</span></span></code></pre>
<p>Running the classifier on this sub-sample costs roughly 50 cents and
takes 12 minutes. To ensure that the output is correct, we can export
the results to Excel with <code>write_xlsx</code> from the
<code>writexl</code> package and manually fix miss-classifications:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Step 1: Bind the sub-sample classifications with descriptive occupation titles</span></span>
<span><span class="co"># We also include special codes for errors and invalid responses</span></span>
<span><span class="va">classified_with_titles</span> <span class="op">&lt;-</span> <span class="va">sub_sample_classified</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">occ_codes</span> <span class="op">|&gt;</span> </span>
<span>      <span class="co"># Add error codes and titles to the occupation code table</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>          <span class="op">~</span><span class="va">occ2</span>, <span class="op">~</span><span class="va">occ_title</span>,</span>
<span>          <span class="fl">97</span>, <span class="st">"API-Connection Failure"</span>,</span>
<span>          <span class="fl">98</span>, <span class="st">"Invalid Response"</span>,</span>
<span>          <span class="fl">99</span>, <span class="st">"Missing (No Clear Occupation)"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>, </span>
<span>    by <span class="op">=</span> <span class="st">"occ2"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Save the results to an Excel file for manual review</span></span>
<span><span class="co"># This allows us to inspect the classifications and any potential errors.</span></span>
<span><span class="fu">writexl</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/writexl/reference/write_xlsx.html" class="external-link">write_xlsx</a></span><span class="op">(</span><span class="va">classified_with_titles</span>, <span class="st">"ground_truth_excel.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>A manual review of the classifier’s output showed highly promising
results. Out of 443 classifications, only 9 needed corrections,
indicating an error rate of just 2% for the <code><a href="../reference/claude.html">claude()</a></code>-based
classifier with our initial prompt. Most issues arose from not correctly
identifying unclear responses as missing, such as “Doin’ the numbers” or
“Barster” (a potential mix of Barrister or Barkeeper). Interestingly, in
5 of the 9 error cases, the model returned an invalid response (code
<code>98</code>) instead of missing (code <code>99</code>), which
suggests it correctly avoided making an incorrect guess, rather than
misclassifying the occupations outright.</p>
<p>While we could likely proceed with classifying the rest of the
dataset using the <code><a href="../reference/claude.html">claude()</a></code>-based classifier, given its
strong performance, we now have a solid ground truth to work with. This
allows us to experiment with different models and prompts to determine
if simpler alternatives or small local models would perform just as
well.</p>
</div>
</div>
<div class="section level2">
<h2 id="optimizing-and-testing-the-classifiers">Optimizing and Testing the Classifiers<a class="anchor" aria-label="anchor" href="#optimizing-and-testing-the-classifiers"></a>
</h2>
<p>Now that we have a reliable ground-truth dataset, it’s time to
optimize and experiment with different model configurations. We’ll split
the dataset into training and test sets using <code>rsample</code> to
ensure that we can experiment with different prompts and setups on
training data but only evaluate our final model performance on unseen
data.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ground_truth</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">:::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xlsx</a></span><span class="op">(</span><span class="st">"ground_truth_corrected.xlsx"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split the ground-truth into training and testing sets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">gt_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">initial_split</a></span><span class="op">(</span><span class="va">ground_truth</span>, prop <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Retrieve training and testing data</span></span>
<span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">training</a></span><span class="op">(</span><span class="va">gt_split</span><span class="op">)</span></span>
<span><span class="va">test_data</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">testing</a></span><span class="op">(</span><span class="va">gt_split</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">train_data</span>,n<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 309 × 3</span></span></span>
<span><span class="co">#&gt;   occupation_open              occ2 occ_title                                   </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Computer network technician    15 Computer and Mathematical Occupations       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Educational support            25 Educational Instruction and Library Occupat…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Fine Carpentry                 47 Construction and Extraction Occupations     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Keep things organized          43 Office and Administrative Support Occupatio…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Group fitness instructor       39 Personal Care and Service Occupations       </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 304 more rows</span></span></span></code></pre></div>
<div class="section level3">
<h3 id="modifying-the-classifier-function">Modifying the Classifier Function<a class="anchor" aria-label="anchor" href="#modifying-the-classifier-function"></a>
</h3>
<p>To test different prompts and models systematically we need to allow
for a more flexible classifier function that can handle different
prompts or models. For this we take the prompt-building logic out of the
function and allow for different api-functions and models as function
arguments:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># External numerical code list for reusability</span></span>
<span><span class="va">numerical_code_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">      11 = Management Occupations                                    </span></span>
<span><span class="st">      13 = Business and Financial Operations Occupations             </span></span>
<span><span class="st">      15 = Computer and Mathematical Occupations                     </span></span>
<span><span class="st">      ... abreviated ...</span></span>
<span><span class="st">      51 = Production Occupations                                    </span></span>
<span><span class="st">      53 = Transportation and Material Moving Occupations</span></span>
<span><span class="st">      99 = Missing Occupation'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Classification function that accepts prompt, api_function, and model </span></span>
<span><span class="co"># as well as the ground truth to pass through as arguments</span></span>
<span><span class="va">classify_occupation_grid</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">occupation</span>,</span>
<span>                                <span class="va">occ2</span>,</span>
<span>                                <span class="va">prompt</span>,</span>
<span>                                <span class="va">prompt_id</span>,</span>
<span>                                <span class="va">api_function</span>,</span>
<span>                                <span class="va">model</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Output what the model is currently doing to the console</span></span>
<span>  <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"Classifying: {model} - {prompt_id} - {occupation}\n"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># List of valid codes as strings</span></span>
<span>  <span class="va">valid_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">occ_codes</span><span class="op">$</span><span class="va">occ2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Initialize classification_raw</span></span>
<span>  <span class="va">classification</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="co"># Get the assistant's reply using the dynamically provided API function and model</span></span>
<span>    <span class="va">assistant_reply</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_message.html">llm_message</a></span><span class="op">(</span><span class="va">prompt</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">api_function</span><span class="op">(</span>.model <span class="op">=</span> <span class="va">model</span>, .temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/last_reply.html">last_reply</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_squish</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Validate the assistant's reply</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">assistant_reply</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">valid_codes</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">assistant_reply</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fl">98L</span>  <span class="co"># Return 98 for invalid responses</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fl">97L</span>  <span class="co"># Return 97 in case of an error (e.g., API failure)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return a tibble containing the original occupation description and classification result</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    occupation_open <span class="op">=</span> <span class="va">occupation</span>,</span>
<span>    occ2_predict    <span class="op">=</span> <span class="va">classification</span>,</span>
<span>    occ2_truth      <span class="op">=</span> <span class="va">occ2</span>,</span>
<span>    model           <span class="op">=</span> <span class="va">model</span>,</span>
<span>    prompt_id       <span class="op">=</span> <span class="va">prompt_id</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="defining-the-prompt-and-model-grid">Defining the Prompt and Model Grid<a class="anchor" aria-label="anchor" href="#defining-the-prompt-and-model-grid"></a>
</h3>
<p>We’ll define a set of prompts and models that we want to test. This
will allow us to apply the classifier across different configurations
and compare results. Here’s how the prompts and models are set up:</p>
<ol style="list-style-type: decimal">
<li><strong>Prompts:</strong></li>
</ol>
<ul>
<li>
<strong>Prompt 1:</strong> A detailed prompt, asking the model to
classify occupations and warning it not to make guesses.</li>
<li>
<strong>Prompt 2:</strong> Explicitly ask to handle invalid
responses by returning a special code (99) when the input does not
resemble a valid occupation.</li>
<li>
<strong>Prompt 3:</strong> A shorter, more concise version to test
whether the model performs similarly with less detailed
instructions.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Models:</strong></li>
</ol>
<ul>
<li>
<strong>Llama3.2:3B:</strong> A opensource large language model with
just 3 billion parameters that is very fast, when you run it locally via
<code><a href="../reference/ollama.html">ollama()</a></code>
</li>
<li>
<strong>Gemma2:9B:</strong> Another candidate model, which performs
well for classification tasks, but is more than double the size of
Lama3.2 and is therefore somewhat slower.</li>
</ul>
<p>We set up a grid combining all the prompts and models. The
<code><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid()</a></code> function from the tidyverse is a useful tool
here to create every possible combination of prompts and models, which
we will use to evaluate the classifier:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prompts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>prompt <span class="op">=</span> </span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="co">#Original prompt</span></span>
<span>            <span class="st">'Classify this occupation response from a survey: {occupation}</span></span>
<span><span class="st">            Pick one of the following numerical codes from this list. </span></span>
<span><span class="st">            Respond only with the code!</span></span>
<span><span class="st">            {numerical_code_list}'</span>,</span>
<span>            <span class="co">#Explicit instruction to avoid classifying something wrong</span></span>
<span>           <span class="st">'Classify this occupation response from a survey: {occupation}</span></span>
<span><span class="st">            Pick one of the following numerical codes from this list. </span></span>
<span><span class="st">            Respond only with the code!</span></span>
<span><span class="st">            {numerical_code_list}</span></span>
<span><span class="st">           </span></span>
<span><span class="st">            If this does not look like a valid occupation response reply with </span></span>
<span><span class="st">            just 99</span></span>
<span><span class="st">           '</span>,</span>
<span>           <span class="co">#Shorter prompt</span></span>
<span>           <span class="st">'Classify this occupation: {occupation}. </span></span>
<span><span class="st">           Respond only with one of the following codes: </span></span>
<span><span class="st">           {numerical_code_list}'</span></span>
<span>         <span class="op">)</span>,</span>
<span>         prompt_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span><span class="va">train_data</span>, </span>
<span>                    <span class="va">prompts</span>, </span>
<span>                    model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"llama3.2"</span>, <span class="st">"gemma2"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># Arrange by model so ollama does not reload them often</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>occupation <span class="op">=</span> <span class="va">occupation_open</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="co"># Glue together prompts and occupation row-by-row</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>prompt <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="va">prompt</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># Ungroup after the rowwise operation</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">model</span>,<span class="va">occupation</span>,<span class="va">occ2</span>,<span class="va">prompt_id</span>,<span class="va">prompt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1854</span></span></code></pre></div>
<p>To run the classification across the entire grid, we use
<code><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">pmap_dfr()</a></code> from the purrr package, which allows us to
iterate over multiple arguments simultaneously. Each combination of
occupation response, prompt, and model is passed into the
<code>classify_occupation()</code> function, and the results are
concatenated into a single tibble:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid_results</span> <span class="op">&lt;-</span> <span class="va">grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">pmap_dfr</a></span><span class="op">(</span><span class="va">classify_occupation_grid</span>,</span>
<span>           api_function <span class="op">=</span> <span class="va">ollama</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Classifying: gemma2 - 1 - Computer network technician</span></span>
<span><span class="co">#&gt; Classifying: gemma2 - 2 - Computer network technician</span></span>
<span><span class="co">#&gt; Classifying: gemma2 - 3 - Computer network technician</span></span>
<span><span class="co">#&gt; Classifying: ...</span></span></code></pre>
<blockquote>
<p>⚠️ <strong>Note:</strong> Running an extensive classification grid
like this, especially with large datasets or slow models, can take a
significant amount of time. Therefore, it’s often reasonable to save
intermediate results periodically, so that you don’t lose progress if
something goes wrong (e.g., a crash or a network issue). By combining
<code><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pwalk()</a></code> with <code>save_rds()</code>, you can run each
combination of the grid independently and store results
incrementally.</p>
</blockquote>
<p>After we run our grid we get some insights into how well models and
prompts work on the train data. Here we can experiment with different
models and parameters as much as we want and see what works here.</p>
</div>
<div class="section level3">
<h3 id="accuracy-estimates">Accuracy estimates<a class="anchor" aria-label="anchor" href="#accuracy-estimates"></a>
</h3>
<p>We will create an overview of prediction accuracy overview using the
<code>yardstick</code> package. For many functions we use, we also need
to encode the ground truth and the model predictions as factors:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/yardstick" class="external-link">yardstick</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'yardstick'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:readr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     spec</span></span>
<span></span>
<span><span class="va">gr_factors</span> <span class="op">&lt;-</span> <span class="va">grid_results</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"occ2_"</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">.x</span>,</span>
<span>                        levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">occ_codes</span><span class="op">$</span><span class="va">occ2</span>,<span class="fl">97</span>, <span class="fl">98</span>,<span class="fl">99</span><span class="op">)</span>,</span>
<span>                        labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">occ_codes</span><span class="op">$</span><span class="va">occ_title</span>,<span class="st">"APIFAIL"</span>,<span class="st">"INVALID"</span>,<span class="st">"MISSING"</span><span class="op">)</span></span>
<span>                <span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>First we just just calculate and plot the model accuracy:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">accuracy</span> <span class="op">&lt;-</span> <span class="va">gr_factors</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">prompt_id</span>, <span class="va">model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://yardstick.tidymodels.org/reference/accuracy.html" class="external-link">accuracy</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">occ2_truth</span>, estimate <span class="op">=</span> <span class="va">occ2_predict</span><span class="op">)</span></span>
<span></span>
<span><span class="va">accuracy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">prompt_id</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">.estimate</span>, fill <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Accuracy by Prompt and Model"</span>, x <span class="op">=</span> <span class="st">"Prompt ID"</span>, y <span class="op">=</span> <span class="st">"Accuracy"</span>, fill<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="fl">22</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html" class="external-link">label_percent</a></span><span class="op">(</span><span class="op">)</span>,limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="tidyllm_classifiers_files/figure-html/accuracy-1.png" width="1536"></p>
<p>Here are the main insights of our classification experiment:</p>
<ul>
<li>
<strong>Gemma2</strong> consistently outperforms
<strong>llama3.2</strong>, but even <strong>gemma2’s</strong> top
performance on <em>Prompt 1 (79.1)</em> falls far short of Claude
Sonnet’s <strong>98% accuracy</strong> in the initial run.</li>
<li>The simplified prompt clearly introduces challenges, especially for
the smaller models like <strong>llama3.2</strong>, which shows
particularly poor performance (as low as 20.2% on Prompt 3). This
suggests that these models might not generalize well to slightly varied
or less explicit prompts, whereas Claude is able to handle the
variations with far greater ease.</li>
</ul>
<p>Let’s look at the confusion matrix for the top
<strong>gemma2</strong> performance to see whether any specific
occupation category causes problems here:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">conf_mat</span> <span class="op">&lt;-</span> <span class="va">gr_factors</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">prompt_id</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">model</span> <span class="op">==</span> <span class="st">"gemma2"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://yardstick.tidymodels.org/reference/conf_mat.html" class="external-link">conf_mat</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">occ2_truth</span>, estimate <span class="op">=</span> <span class="va">occ2_predict</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Autoplot the confusion matrix</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">conf_mat</span>, type <span class="op">=</span> <span class="st">"heatmap"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"#E41A1C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Confusion Matrix for Model gemma2, Prompt 1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="fl">22</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre></div>
<p><img src="tidyllm_classifiers_files/figure-html/confmatrix-1.png" width="1536">
A lot of the miss-classifications are in management occupations and
office services, missing occupations are again not classified well, but
classified into other occupations. So nothing that seems like an
immediate easy fix.</p>
<p>Another thing worth trying are cheap, simple and fast chatgpt-4o mini
models. Let’s try it on the initial prompt</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chatgpt_grid</span> <span class="op">&lt;-</span> <span class="va">grid</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model</span><span class="op">==</span><span class="st">"gemma2"</span>, <span class="va">prompt_id</span> <span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"gpt-4o-mini"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">pmap_dfr</a></span><span class="op">(</span><span class="va">classify_occupation_grid</span>,</span>
<span>           api_function <span class="op">=</span> <span class="va">chatgpt</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">chatgpt_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"occ2_"</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">.x</span>,</span>
<span>                        levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">occ_codes</span><span class="op">$</span><span class="va">occ2</span>,<span class="fl">97</span>, <span class="fl">98</span>,<span class="fl">99</span><span class="op">)</span>,</span>
<span>                        labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">occ_codes</span><span class="op">$</span><span class="va">occ_title</span>,<span class="st">"APIFAIL"</span>,<span class="st">"INVALID"</span>,<span class="st">"MISSING"</span><span class="op">)</span></span>
<span>                <span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://yardstick.tidymodels.org/reference/accuracy.html" class="external-link">accuracy</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">occ2_truth</span>, estimate <span class="op">=</span> <span class="va">occ2_predict</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> accuracy multiclass     0.767</span></span></code></pre>
<p>Still worse accuracy than Claude Sonnet and not much better than
<strong>gemma2</strong>. But there is another trick that goes beyond
simple one-shot classification. A common idea is to use multi-shot
classifications (and give the model classification examples in the
prompt, or even guide its output by letting it complete conversations
where it answers the right way). The function
<code><a href="../reference/df_llm_message.html">df_llm_message()</a></code> let’s you easily built such message
histories where you put some words into the mouth of the model. But
there are other ways that can help you increase accuracy. A popular one
is to first let the model reason in detail what the best candidates for
classification would be to build a chain of thought before it gives the
final answer.</p>
</div>
<div class="section level3">
<h3 id="multistep-chain-of-thought-prompting">Multistep Chain-of-Thought Prompting<a class="anchor" aria-label="anchor" href="#multistep-chain-of-thought-prompting"></a>
</h3>
<p>For this we need a major change in the classification function,
because we send two messages to the model. A first one elicits a
reasoning step, the second one asks for the final code, based on the
answer to the first message. This is easily doable with the
message-chaining abilities of <strong>tidyllm</strong></p>
<p>Here is a modified chain of thought prompting function with a
reasoning and an output step:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">classify_occupation_cot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">occupation</span>,</span>
<span>                                    <span class="va">occ2</span>,</span>
<span>                                    <span class="va">api_function</span>,</span>
<span>                                    <span class="va">model</span>,</span>
<span>                                    <span class="va">stream</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Output what the model is currently doing to the console</span></span>
<span>  <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"Classifying with CoT: {model} - {occupation}\n"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Step 1: Ask the model to think through the problem</span></span>
<span>  <span class="va">prompt_reasoning</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">    Think about which of the following occupation codes would best describe this occupation description from a survey respondent: "{occupation}"</span></span>
<span><span class="st">    </span></span>
<span><span class="st">    {numerical_code_list}</span></span>
<span><span class="st">    </span></span>
<span><span class="st">    Explain your reasoning for the 3 top candidate codes step by step. Then evaluate which seems best.</span></span>
<span><span class="st">  '</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">reasoning_response</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">conversation</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="../reference/llm_message.html">llm_message</a></span><span class="op">(</span><span class="va">prompt_reasoning</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">api_function</span><span class="op">(</span>.model <span class="op">=</span> <span class="va">model</span>, .temperature <span class="op">=</span> <span class="fl">0</span>, .stream<span class="op">=</span><span class="va">stream</span><span class="op">)</span> </span>
<span>    </span>
<span>    <span class="va">conversation</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/last_reply.html">last_reply</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">conversation</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="../reference/llm_message.html">llm_message</a></span><span class="op">(</span><span class="st">"Please classify this occupation response: {occupation}"</span><span class="op">)</span></span>
<span>    <span class="st">"Error in reasoning step."</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Step 2: Ask the model to provide the final answer</span></span>
<span>  <span class="va">prompt_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">    Based on your reasoning, which code do you pick? Answer only with a numerical code!</span></span>
<span><span class="st"></span></span>
<span><span class="st">  '</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">final_response</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">conversation</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/llm_message.html">llm_message</a></span><span class="op">(</span><span class="va">prompt_final</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">api_function</span><span class="op">(</span>.model <span class="op">=</span> <span class="va">model</span>, .temperature <span class="op">=</span> <span class="fl">0</span>, .stream<span class="op">=</span><span class="va">stream</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/last_reply.html">last_reply</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html" class="external-link">str_squish</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="st">"97"</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Validate the model's final response</span></span>
<span>  <span class="va">valid_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">occ_codes</span><span class="op">$</span><span class="va">occ2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">classification</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">final_response</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">valid_codes</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">final_response</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fl">98L</span>  <span class="co"># Return 98 for invalid responses</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Return a tibble containing the original occupation description and classification result</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    occupation_open <span class="op">=</span> <span class="va">occupation</span>,</span>
<span>    occ2_predict    <span class="op">=</span> <span class="va">classification</span>,</span>
<span>    occ2_truth      <span class="op">=</span> <span class="va">occ2</span>,</span>
<span>    model           <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{model}_cot"</span><span class="op">)</span>,</span>
<span>    reasoning       <span class="op">=</span> <span class="va">reasoning_response</span>,</span>
<span>    final_response  <span class="op">=</span> <span class="va">final_response</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that this increases the compute time for <strong>gemma2</strong>
massively because it now produces a multiple of the output from before.
Each run produces roughly a page of reasoning, before the second
question generates a number, while our original prompting strategy just
gave us one number. So run-times increase strongly.</p>
<blockquote>
<p><strong>Note:</strong> To test more complicated prompting strategies
like this in realtime, another feature of <strong>tidyllm</strong> comes
in handy. You can stream back responses just like in online chatbot
interfaces during a first test run with the
<code>.stream</code>-argument in most api functions to immediately see
whether you made strange errors in your prompting. Therefore, here we
pass the stream arguement trough <code>classify_occupation_cot()</code>
to first test the function and the prompting on single inputs before we
scale it up to the whole data.</p>
</blockquote>
<p>Let’s run this function with <strong>gemma2</strong>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_cot</span> <span class="op">&lt;-</span> <span class="va">grid</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model</span><span class="op">==</span><span class="st">"gemma2"</span>, <span class="va">prompt_id</span> <span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">prompt</span>,<span class="op">-</span><span class="va">prompt_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">pmap_dfr</a></span><span class="op">(</span><span class="va">classify_occupation_cot</span>,api_function <span class="op">=</span> <span class="va">ollama</span>, stream<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Classifying with CoT: gemma2 - 1 - Computer network technician</span></span>
<span><span class="co">#&gt; Classifying with CoT: gemma2 - 2 - Educational support</span></span>
<span><span class="co">#&gt; Classifying with CoT: gemma2 - 3 - Fine Carpentry</span></span>
<span><span class="co">#&gt; Classifying with CoT: ...</span></span></code></pre>
<p>Did this work. It turns out in this case it did not!</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_cot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"occ2_"</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">.x</span>,</span>
<span>                        levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">occ_codes</span><span class="op">$</span><span class="va">occ2</span>,<span class="fl">97</span>, <span class="fl">98</span>,<span class="fl">99</span><span class="op">)</span>,</span>
<span>                        labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">occ_codes</span><span class="op">$</span><span class="va">occ_title</span>,<span class="st">"APIFAIL"</span>,<span class="st">"INVALID"</span>,<span class="st">"MISSING"</span><span class="op">)</span></span>
<span>                <span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://yardstick.tidymodels.org/reference/accuracy.html" class="external-link">accuracy</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">occ2_truth</span>, estimate <span class="op">=</span> <span class="va">occ2_predict</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span></span>
<span><span class="co">#&gt;   .metric  .estimator .estimate</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> accuracy multiclass     0.754</span></span></code></pre></div>
<p>The accuracy is even worse than without the reasoning step! One
interesting thing though is that the model has the right classification
in one of its candidates in the reasoning step for 94% of the cases. So
probably, there is still some way to get a better final result out of
<strong>gemma2</strong>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_cot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>reasoning_classifications <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract_all</a></span><span class="op">(</span><span class="va">reasoning</span>,<span class="st">"\\d{2}"</span><span class="op">)</span>,</span>
<span>         reasoning_classifications <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_int</a></span><span class="op">(</span><span class="va">reasoning_classifications</span>, <span class="va">as.integer</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         right_in_reasoning <span class="op">=</span> <span class="va">occ2_truth</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">reasoning_classifications</span></span>
<span>         <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">right_in_reasoning</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pct<span class="op">=</span><span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">#&gt;   right_in_reasoning     n    pct</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> FALSE                 19 0.061<span style="text-decoration: underline;">5</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> TRUE                 290 0.939</span></span></code></pre></div>
<p>Yet it likely is not worth to invest more time into trying to get
good results out of a local model for this use-case. Thus, it looks like
we still have a clear favorite final choice without even needing to do
further testing. We already know test performance for Claude Sonnet 3.5
on the original split, since we manually checked it. Paying the roughly
2,50$ for the Anthropic API and use Claude Sonnet to classify the whole
sample at 98% accuracy is probably worth it in this case. So the final
step is to use the initial <code>classify_occupation()</code> based on
<code><a href="../reference/claude.html">claude()</a></code> on all data.</p>
</div>
</div>
<div class="section level2">
<h2 id="scaling-up-to-the-full-dataset">Scaling Up to the Full Dataset<a class="anchor" aria-label="anchor" href="#scaling-up-to-the-full-dataset"></a>
</h2>
<p>So we choose Claude 3.5 sonnet, our original prompt and apply it to
our data-set:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">full_occupations_classified</span> <span class="op">&lt;-</span> <span class="va">distinct_occupations</span><span class="op">$</span><span class="va">occupation</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">classify_occupation</span><span class="op">)</span></span>
<span></span>
<span><span class="va">occ_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">full_occupations_classified</span>, by<span class="op">=</span><span class="st">"occupation_open"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this article, we’ve demonstrated how <code>tidyllm</code> can be
effectively used to tackle complex text classification tasks. By walking
through the process step-by-step, from sample selection and prompt
design to model testing and optimization, we’ve highlighted the
flexibility of the package in dealing with real-world data.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Eduard Brüll.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
